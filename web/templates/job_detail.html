{% extends "base.html" %}
{% block title %}Job {{ job_id }} â€“ PhotoMigrator{% endblock %}
{% block content %}
  <h2>Job {{ job_id }}</h2>
  <p><strong>Mode:</strong> {{ job.mode }} &nbsp; <strong>Status:</strong> {{ job.status.value }}</p>
  {% if job.error %}
  <p class="error"><strong>Error:</strong> {{ job.error }}</p>
  {% endif %}
  {% if job.result_summary %}
  <p class="result">{{ job.result_summary }}</p>
  {% endif %}

  <h3>Log</h3>
  <pre id="log-output" class="log-output">{% for line in job.log_lines %}{{ line }}
{% endfor %}</pre>

  <p><a href="/">Back to home</a></p>

  {% if job.status.value == "running" or job.status.value == "pending" %}
  <script>
    (function poll() {
      fetch('/api/jobs/{{ job_id }}/logs')
        .then(function(r) { return r.json(); })
        .then(function(d) {
          var el = document.getElementById('log-output');
          if (el && d.lines) el.textContent = d.lines.join('\n');
          if (d.lines && document.querySelector('strong') && document.body.innerText.indexOf('Status: running') !== -1)
            setTimeout(poll, 2000);
        })
        .catch(function() { setTimeout(poll, 3000); });
    })();
  </script>
  {% endif %}
{% endblock %}
